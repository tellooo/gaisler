

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>ThreadSanitizer &mdash; Clang 8 documentation</title>
    
    <link rel="stylesheet" href="_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/print.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '8',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="_static/theme_extras.js"></script>
    <link rel="top" title="Clang 8 documentation" href="index.html" />
    <link rel="next" title="MemorySanitizer" href="MemorySanitizer.html" />
    <link rel="prev" title="AddressSanitizer" href="AddressSanitizer.html" /> 
  </head>
  <body>
      <div class="header"><h1 class="heading"><a href="index.html">
          <span>Clang 8 documentation</span></a></h1>
        <h2 class="heading"><span>ThreadSanitizer</span></h2>
      </div>
      <div class="topnav">
      
        <p>
        «&#160;&#160;<a href="AddressSanitizer.html">AddressSanitizer</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="MemorySanitizer.html">MemorySanitizer</a>&#160;&#160;»
        </p>

      </div>
      <div class="content">
        
        
  <div class="section" id="threadsanitizer">
<h1>ThreadSanitizer<a class="headerlink" href="#threadsanitizer" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>ThreadSanitizer is a tool that detects data races.  It consists of a compiler
instrumentation module and a run-time library.  Typical slowdown introduced by
ThreadSanitizer is about <strong>5x-15x</strong>.  Typical memory overhead introduced by
ThreadSanitizer is about <strong>5x-10x</strong>.</p>
</div>
<div class="section" id="how-to-build">
<h2>How to build<a class="headerlink" href="#how-to-build" title="Permalink to this headline">¶</a></h2>
<p>Build LLVM/Clang with <a class="reference external" href="https://llvm.org/docs/CMake.html">CMake</a>.</p>
</div>
<div class="section" id="supported-platforms">
<h2>Supported Platforms<a class="headerlink" href="#supported-platforms" title="Permalink to this headline">¶</a></h2>
<p>ThreadSanitizer is supported on the following OS:</p>
<ul class="simple">
<li>Linux</li>
<li>NetBSD</li>
<li>FreeBSD</li>
</ul>
<p>Support for other 64-bit architectures is possible, contributions are welcome.
Support for 32-bit platforms is problematic and is not planned.</p>
</div>
<div class="section" id="usage">
<h2>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h2>
<p>Simply compile and link your program with <tt class="docutils literal"><span class="pre">-fsanitize=thread</span></tt>.  To get a
reasonable performance add <tt class="docutils literal"><span class="pre">-O1</span></tt> or higher.  Use <tt class="docutils literal"><span class="pre">-g</span></tt> to get file names
and line numbers in the warning messages.</p>
<p>Example:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">%</span> cat projects/compiler-rt/lib/tsan/lit_tests/tiny_race.c
<span class="gp">#</span>include &lt;pthread.h&gt;
<span class="go">int Global;</span>
<span class="go">void *Thread1(void *x) {</span>
<span class="go">  Global = 42;</span>
<span class="go">  return x;</span>
<span class="go">}</span>
<span class="go">int main() {</span>
<span class="go">  pthread_t t;</span>
<span class="go">  pthread_create(&amp;t, NULL, Thread1, NULL);</span>
<span class="go">  Global = 43;</span>
<span class="go">  pthread_join(t, NULL);</span>
<span class="go">  return Global;</span>
<span class="go">}</span>

<span class="gp">$</span> clang -fsanitize<span class="o">=</span>thread -g -O1 tiny_race.c
</pre></div>
</div>
<p>If a bug is detected, the program will print an error message to stderr.
Currently, ThreadSanitizer symbolizes its output using an external
<tt class="docutils literal"><span class="pre">addr2line</span></tt> process (this will be fixed in future).</p>
<div class="highlight-bash"><div class="highlight"><pre>% ./a.out
WARNING: ThreadSanitizer: data race <span class="o">(</span><span class="nv">pid</span><span class="o">=</span>19219<span class="o">)</span>
  Write of size 4 at 0x7fcf47b21bc0 by thread T1:
    <span class="c">#0 Thread1 tiny_race.c:4 (exe+0x00000000a360)</span>

  Previous write of size 4 at 0x7fcf47b21bc0 by main thread:
    <span class="c">#0 main tiny_race.c:10 (exe+0x00000000a3b4)</span>

  Thread T1 <span class="o">(</span>running<span class="o">)</span> created at:
    <span class="c">#0 pthread_create tsan_interceptors.cc:705 (exe+0x00000000c790)</span>
    <span class="c">#1 main tiny_race.c:9 (exe+0x00000000a3a4)</span>
</pre></div>
</div>
</div>
<div class="section" id="has-feature-thread-sanitizer">
<h2><tt class="docutils literal"><span class="pre">__has_feature(thread_sanitizer)</span></tt><a class="headerlink" href="#has-feature-thread-sanitizer" title="Permalink to this headline">¶</a></h2>
<p>In some cases one may need to execute different code depending on whether
ThreadSanitizer is enabled.
<a class="reference internal" href="LanguageExtensions.html#langext-has-feature-has-extension"><em>__has_feature</em></a> can be used for
this purpose.</p>
<div class="highlight-c"><div class="highlight"><pre><span class="cp">#if defined(__has_feature)</span>
<span class="cp">#  if __has_feature(thread_sanitizer)</span>
<span class="c1">// code that builds only under ThreadSanitizer</span>
<span class="cp">#  endif</span>
<span class="cp">#endif</span>
</pre></div>
</div>
</div>
<div class="section" id="attribute-no-sanitize-thread">
<h2><tt class="docutils literal"><span class="pre">__attribute__((no_sanitize(&quot;thread&quot;)))</span></tt><a class="headerlink" href="#attribute-no-sanitize-thread" title="Permalink to this headline">¶</a></h2>
<p>Some code should not be instrumented by ThreadSanitizer.  One may use the
function attribute <tt class="docutils literal"><span class="pre">no_sanitize(&quot;thread&quot;)</span></tt> to disable instrumentation of plain
(non-atomic) loads/stores in a particular function.  ThreadSanitizer still
instruments such functions to avoid false positives and provide meaningful stack
traces.  This attribute may not be supported by other compilers, so we suggest
to use it together with <tt class="docutils literal"><span class="pre">__has_feature(thread_sanitizer)</span></tt>.</p>
</div>
<div class="section" id="blacklist">
<h2>Blacklist<a class="headerlink" href="#blacklist" title="Permalink to this headline">¶</a></h2>
<p>ThreadSanitizer supports <tt class="docutils literal"><span class="pre">src</span></tt> and <tt class="docutils literal"><span class="pre">fun</span></tt> entity types in
<a class="reference internal" href="SanitizerSpecialCaseList.html"><em>Sanitizer special case list</em></a>, that can be used to suppress data race reports
in the specified source files or functions. Unlike functions marked with
<tt class="docutils literal"><span class="pre">no_sanitize(&quot;thread&quot;)</span></tt> attribute, blacklisted functions are not instrumented
at all. This can lead to false positives due to missed synchronization via
atomic operations and missed stack frames in reports.</p>
</div>
<div class="section" id="limitations">
<h2>Limitations<a class="headerlink" href="#limitations" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>ThreadSanitizer uses more real memory than a native run. At the default
settings the memory overhead is 5x plus 1Mb per each thread. Settings with 3x
(less accurate analysis) and 9x (more accurate analysis) overhead are also
available.</li>
<li>ThreadSanitizer maps (but does not reserve) a lot of virtual address space.
This means that tools like <tt class="docutils literal"><span class="pre">ulimit</span></tt> may not work as usually expected.</li>
<li>Libc/libstdc++ static linking is not supported.</li>
<li>Non-position-independent executables are not supported.  Therefore, the
<tt class="docutils literal"><span class="pre">fsanitize=thread</span></tt> flag will cause Clang to act as though the <tt class="docutils literal"><span class="pre">-fPIE</span></tt>
flag had been supplied if compiling without <tt class="docutils literal"><span class="pre">-fPIC</span></tt>, and as though the
<tt class="docutils literal"><span class="pre">-pie</span></tt> flag had been supplied if linking an executable.</li>
</ul>
</div>
<div class="section" id="current-status">
<h2>Current Status<a class="headerlink" href="#current-status" title="Permalink to this headline">¶</a></h2>
<p>ThreadSanitizer is in beta stage.  It is known to work on large C++ programs
using pthreads, but we do not promise anything (yet).  C++11 threading is
supported with llvm libc++.  The test suite is integrated into CMake build
and can be run with <tt class="docutils literal"><span class="pre">make</span> <span class="pre">check-tsan</span></tt> command.</p>
<p>We are actively working on enhancing the tool &#8212; stay tuned.  Any help,
especially in the form of minimized standalone tests is more than welcome.</p>
</div>
<div class="section" id="more-information">
<h2>More Information<a class="headerlink" href="#more-information" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://github.com/google/sanitizers/wiki/ThreadSanitizerCppManual">https://github.com/google/sanitizers/wiki/ThreadSanitizerCppManual</a></p>
</div>
</div>


      </div>
      <div class="bottomnav">
      
        <p>
        «&#160;&#160;<a href="AddressSanitizer.html">AddressSanitizer</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="MemorySanitizer.html">MemorySanitizer</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer">
        &copy; Copyright 2007-2019, The Clang Team.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>