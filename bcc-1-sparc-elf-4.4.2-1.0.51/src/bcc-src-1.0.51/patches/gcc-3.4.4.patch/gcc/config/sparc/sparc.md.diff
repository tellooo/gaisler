--- gcc-3.4.4.old/./gcc/config/sparc/sparc.md	2020-02-28 17:30:18.263573049 +0100
+++ gcc-3.4.4.new/./gcc/config/sparc/sparc.md	2017-11-16 16:05:34.088973000 +0100
@@ -67,6 +67,7 @@
 (define_attr "cpu"
   "v7,
    cypress,
+   leon,
    v8,
    supersparc,
    sparclite,f930,f934,
@@ -127,6 +128,23 @@
 (define_attr "flat" "false,true"
   (symbol_ref "TARGET_FLAT != 0"))
 
+(define_attr "fix_b2bst" "false,true"
+(symbol_ref "(sparc_fix_b2bst != 0
+         ? FIX_B2BST_TRUE : FIX_B2BST_FALSE)"))
+
+(define_attr "fix_tn0013" "false,true"
+   (symbol_ref "(sparc_fix_tn0013 != 0
+		 ? FIX_TN0013_TRUE : FIX_TN0013_FALSE)"))
+
+(define_attr "fix_gr712rc" "false,true"
+(symbol_ref "(sparc_fix_gr712rc != 0
+         ? FIX_GR712RC_TRUE : FIX_GR712RC_FALSE)"))
+
+(define_attr "load_in_delay" "false,true"
+  (if_then_else (and (eq_attr "type" "load") (eq (symbol_ref "sparc_fix_load_in_delay") (const_int 1)))
+	 	(const_string "false")
+	 	(const_string "true")))
+
 ;; Length (in # of insns).
 ;; Beware that setting a length greater or equal to 3 for conditional branches
 ;; has a side-effect (see output_cbranch and output_v9branch).
@@ -212,11 +230,30 @@
 (define_attr "tls_call_delay" "false,true"
   (symbol_ref "tls_call_delay (insn)"))
 
+(define_attr "fpsingle_in_delay" "false,true"
+  (cond [(eq (symbol_ref "fpstore_errata") (const_int 0))
+		(const_string "false")
+	 (eq_attr "type" "fpload")
+		(const_string "true")
+	 (and (eq_attr "type" "fpmove,fpmul,fpdivs,fpsqrts") (eq_attr "fptype" "single"))
+		(const_string "true")
+	 (eq_attr "type" "fp")
+		(const_string "true")]
+	(const_string "false")))
+
+(define_attr "fpsingle_in_branch_delay" "false,true"
+  (if_then_else (and (eq_attr "fpsingle_in_delay" "true")
+		     (eq (symbol_ref "fpstore_branch_slots") (const_int 1)))
+		(const_string "true")
+		(const_string "false")))
+
 (define_attr "in_call_delay" "false,true"
   (cond [(eq_attr "type" "uncond_branch,branch,call,sibcall,call_no_delay_slot,multi")
 	 	(const_string "false")
+	 (eq_attr "fpsingle_in_delay" "true")
+	 	(const_string "false")
 	 (eq_attr "type" "load,fpload,store,fpstore")
-	 	(if_then_else (eq_attr "length" "1")
+	 	(if_then_else (and (eq_attr "length" "1") (eq_attr "load_in_delay" "true"))
 			      (const_string "true")
 			      (const_string "false"))]
 	(if_then_else (and (eq_attr "length" "1")
@@ -228,7 +265,9 @@
   [(eq_attr "in_call_delay" "true") (nil) (nil)])
 
 (define_attr "eligible_for_sibcall_delay" "false,true"
-  (symbol_ref "eligible_for_sibcall_delay (insn)"))
+  (cond [(eq_attr "fpsingle_in_delay" "true")
+	 	(const_string "false")]
+	(symbol_ref "eligible_for_sibcall_delay (insn)")))
 
 (define_delay (eq_attr "type" "sibcall")
   [(eq_attr "eligible_for_sibcall_delay" "true") (nil) (nil)])
@@ -249,22 +288,44 @@
 ;; because it prevents us from moving back the final store of inner loops.
 
 (define_attr "in_branch_delay" "false,true"
-  (if_then_else (and (eq_attr "type" "!uncond_branch,branch,call,sibcall,call_no_delay_slot,multi")
-		     (eq_attr "length" "1"))
-		(const_string "true")
-		(const_string "false")))
+  (cond [(and (eq_attr "fix_b2bst" "true") (eq_attr "type" "store,fpstore"))
+           (const_string "false")
+	 (and (eq_attr "fix_tn0013" "true")
+	      (eq_attr "type" "fpdivs,fpsqrts,fpdivd,fpsqrtd"))
+	   (const_string "false")
+	     (and (and (and (eq_attr "type" "!uncond_branch,branch,call,sibcall,call_no_delay_slot,multi")
+		    (eq_attr "length" "1"))  (eq_attr "load_in_delay" "true"))
+		    (eq_attr "fpsingle_in_branch_delay" "false"))
+           (const_string "true")
+        ] (const_string "false")))
 
 (define_attr "in_uncond_branch_delay" "false,true"
-  (if_then_else (and (eq_attr "type" "!uncond_branch,branch,call,sibcall,call_no_delay_slot,multi")
-		     (eq_attr "length" "1"))
-		(const_string "true")
-		(const_string "false")))
+  (cond [(and (eq_attr "fix_b2bst" "true") (eq_attr "type" "store,fpstore"))
+           (const_string "false")
+	 (and (eq_attr "fix_tn0013" "true")
+	      (eq_attr "type" "fpdivs,fpsqrts,fpdivd,fpsqrtd"))
+	   (const_string "false")
+	     (and (and (and (eq_attr "type" "!uncond_branch,branch,call,sibcall,call_no_delay_slot,multi")
+		    (eq_attr "length" "1"))  (eq_attr "load_in_delay" "true"))
+		    (eq_attr "fpsingle_in_branch_delay" "false"))
+           (const_string "true")
+        ] (const_string "false")))
 
 (define_attr "in_annul_branch_delay" "false,true"
-  (if_then_else (and (eq_attr "type" "!uncond_branch,branch,call,sibcall,call_no_delay_slot,multi")
-		     (eq_attr "length" "1"))
-		(const_string "true")
-		(const_string "false")))
+(cond [(and (eq_attr "fix_gr712rc" "true")
+	    (eq_attr "type" "fp,fpcmp,fpmove,fpcmove,fpmul,
+			      fpdivs,fpsqrts,fpdivd,fpsqrtd"))
+		(const_string "false")
+	 (and (eq_attr "fix_tn0013" "true")
+	      (eq_attr "type" "fpdivs,fpsqrts,fpdivd,fpsqrtd"))
+	   (const_string "false")
+         (and (eq_attr "fix_b2bst" "true") (eq_attr "type" "store,fpstore"))
+           (const_string "false")
+	     (and (and (and (eq_attr "type" "!uncond_branch,branch,call,sibcall,call_no_delay_slot,multi")
+		    (eq_attr "length" "1"))  (eq_attr "load_in_delay" "true"))
+		    (eq_attr "fpsingle_in_branch_delay" "false"))
+           (const_string "true")
+        ] (const_string "false")))
 
 (define_delay (eq_attr "type" "branch")
   [(eq_attr "in_branch_delay" "true")
@@ -282,6 +343,7 @@
 (include "sparclet.md")
 (include "ultra1_2.md")
 (include "ultra3.md")
+(include "leon.md")
 
 
 ;; Compare instructions.
@@ -6652,7 +6714,7 @@
   [(set (match_operand:DF 0 "register_operand" "=e")
 	(mult:DF (float_extend:DF (match_operand:SF 1 "register_operand" "f"))
 		 (float_extend:DF (match_operand:SF 2 "register_operand" "f"))))]
-  "(TARGET_V8 || TARGET_V9) && TARGET_FPU"
+  "(TARGET_V8 || TARGET_V9) && TARGET_FPU && (!TARGET_NO_FSMULD)"
   "fsmuld\t%1, %2, %0"
   [(set_attr "type" "fpmul")
    (set_attr "fptype" "double")])
@@ -6681,22 +6743,42 @@
   "fdivq\t%1, %2, %0"
   [(set_attr "type" "fpdivd")])
 
+;;;;;;;;;;;;;;;;;; handle divdf3 ;;;;;;;;;;;;;;;;
+
 (define_insn "divdf3"
   [(set (match_operand:DF 0 "register_operand" "=e")
 	(div:DF (match_operand:DF 1 "register_operand" "e")
 		(match_operand:DF 2 "register_operand" "e")))]
   "TARGET_FPU"
-  "fdivd\t%1, %2, %0"
+  {
+    return (TARGET_STORE_AFTER_DIVSQRT)
+         ? "nop; fdivd\t%1, %2, %0; st %0, [%%sp-8]; nop; nop"
+         : "fdivd\t%1, %2, %0";
+  }
   [(set_attr "type" "fpdivd")
-   (set_attr "fptype" "double")])
+   (set_attr "fptype" "double")
+   (set (attr "length")
+	(if_then_else (eq (symbol_ref "TARGET_STORE_AFTER_DIVSQRT") (const_int 0))
+		      (const_int 1) (const_int 5)))])
+
+;;;;;;;;;;;;;;;;;; handle divsf3 ;;;;;;;;;;;;;;;;
 
 (define_insn "divsf3"
   [(set (match_operand:SF 0 "register_operand" "=f")
 	(div:SF (match_operand:SF 1 "register_operand" "f")
 		(match_operand:SF 2 "register_operand" "f")))]
-  "TARGET_FPU"
-  "fdivs\t%1, %2, %0"
-  [(set_attr "type" "fpdivs")])
+  "TARGET_FPU && (!TARGET_NO_SF_DIVSQRT)"
+  {
+    return (TARGET_STORE_AFTER_DIVSQRT)
+    	   ? "nop; fdivs\t%1, %2, %0; st %0, [%%sp-8]; nop; nop"
+	   : "fdivs\t%1, %2, %0";
+  }
+  [(set_attr "type" "fpdivs")
+   (set (attr "length")	
+	(if_then_else (eq (symbol_ref "TARGET_STORE_AFTER_DIVSQRT") (const_int 0))
+		      (const_int 1) (const_int 5)))])
+
+;;;;;;;;;;;;;;;;;;
 
 (define_expand "negtf2"
   [(set (match_operand:TF 0 "register_operand" "=e,e")
@@ -6895,21 +6977,41 @@
   "fsqrtq\t%1, %0"
   [(set_attr "type" "fpsqrtd")])
 
+;;;;;;;;;;;;;;;;;; handle sqrtdf2 ;;;;;;;;;;;;;;;; 
+
 (define_insn "sqrtdf2"
   [(set (match_operand:DF 0 "register_operand" "=e")
 	(sqrt:DF (match_operand:DF 1 "register_operand" "e")))]
   "TARGET_FPU"
-  "fsqrtd\t%1, %0"
+  {
+	return TARGET_STORE_AFTER_DIVSQRT
+	       ? "nop; fsqrtd\t%1, %0; st %0, [%%sp-8]; nop; nop"
+	       : "fsqrtd\t%1, %0";
+  }
   [(set_attr "type" "fpsqrtd")
-   (set_attr "fptype" "double")])
+   (set_attr "fptype" "double")
+   (set (attr "length")	
+	(if_then_else (eq (symbol_ref "TARGET_STORE_AFTER_DIVSQRT") (const_int 0))
+		      (const_int 1) (const_int 5)))])
+
+;;;;;;;;;;;;;;;;;; handle sqrtsf2 ;;;;;;;;;;;;;;;;
 
 (define_insn "sqrtsf2"
   [(set (match_operand:SF 0 "register_operand" "=f")
 	(sqrt:SF (match_operand:SF 1 "register_operand" "f")))]
-  "TARGET_FPU"
-  "fsqrts\t%1, %0"
-  [(set_attr "type" "fpsqrts")])
-
+  "TARGET_FPU  && (!TARGET_NO_SF_DIVSQRT)"
+  {
+	return TARGET_STORE_AFTER_DIVSQRT
+	       ? "nop; fsqrts\t%1, %0; st %0, [%%sp-8]; nop; nop"
+	       : "fsqrts\t%1, %0";
+  }
+  [(set_attr "type" "fpsqrts")
+   (set (attr "length")	
+	(if_then_else (eq (symbol_ref "TARGET_STORE_AFTER_DIVSQRT") (const_int 0))
+		      (const_int 1) (const_int 5)))])
+
+;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
+
 ;;- arithmetic shift instructions
 
 (define_insn "ashlsi3"
@@ -8253,9 +8355,9 @@
 	(match_operand:SF 0 "register_operand" "f"))
    (return)]
   "sparc_emitting_epilogue"
-  "ret\;fmovs\t%0, %%f0"
+  "nop\;fmovs\t%0, %%f0\;ret\;nop"
   [(set_attr "type" "multi")
-   (set_attr "length" "2")])
+   (set_attr "length" "4")])
 
 ;; ??? UltraSPARC-III note: A memory operation loading into the floating point register
 ;; ??? file, if it hits the prefetch cache, has a chance to dual-issue with other memory
