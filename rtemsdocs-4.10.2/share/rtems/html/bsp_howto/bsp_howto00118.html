<HTML>
<!-- created Dec 13 2011 from network.texi line 186 via texi2www -->
<BODY BGCOLOR="FFFFFF">
<A HREF="http://www.rtems.com" target="Text Frame">
  <IMG align=right BORDER=0 SRC="../images/rtems_logo.jpg" ALT="RTEMS Logo"> </A>
<H1>RTEMS 4.10.2 On-Line Library</H1>
<HR>
<HEAD>
<TITLE>Networking Driver Write the Driver Attach Function</TITLE>
<LINK REL="Precedes" HREF="bsp_howto00119.html">
<LINK REV="Precedes" HREF="bsp_howto00117.html">
<LINK REV="Subdocument" HREF="bsp_howto00113.html">
<LINK REV="Library" HREF="../index.html">
</HEAD><BODY><P>
<A HREF="bsp_howto00117.html"><IMG ALIGN=MIDDLE SRC="../images/prev-arrow.gif" ALT="PREV"></A>
<A HREF="bsp_howto00113.html"> <IMG ALIGN=MIDDLE SRC="../images/up-arrow.gif" ALT="UP"></A>
<A HREF="bsp_howto00119.html"><IMG ALIGN=MIDDLE SRC="../images/next-arrow.gif" ALT="NEXT"></A>
<A HREF="../index.html"> <IMG ALIGN=MIDDLE SRC="../images/dir-arrow.gif" ALT="Bookshelf"></A>
<CITE>BSP and Device Driver Development Guide</CITE></P>
<H2>15.5: Write the Driver Attach Function</H2>
<P>
The driver attach function is responsible for configuring the driver
and making the connection between the network stack
and the driver.
</P>
<P>
Driver attach functions take a pointer to an
<CODE>rtems_bsdnet_ifconfig</CODE> structure as their only argument.
and set the driver parameters based on the
values in this structure.  If an entry in the configuration
structure is zero the attach function chooses an
appropriate default value for that parameter.
</P>
<P>
The driver should then set up several fields in the ifnet structure
in the device-dependent data structure supplied and maintained by the driver:
</P>
<DL>
<DT><CODE>ifp-&gt;if_softc</CODE>
<DD>
Pointer to the device-dependent data.  The first entry
in the device-dependent data structure must be an <CODE>arpcom</CODE>
structure.

<DT><CODE>ifp-&gt;if_name</CODE>
<DD>
The name of the device.  The network stack uses this string
and the device number for device name lookups.  The device name should
be obtained from the <CODE>name</CODE> entry in the configuration structure.

<DT><CODE>ifp-&gt;if_unit</CODE>
<DD>
The device number.  The network stack uses this number and the
device name for device name lookups.  For example, if
<CODE>ifp-&gt;if_name</CODE> is `<CODE>scc</CODE>' and <CODE>ifp-&gt;if_unit</CODE> is `<CODE>1</CODE>',
the full device name would be `<CODE>scc1</CODE>'.  The unit number should be
obtained from the `name' entry in the configuration structure.

<DT><CODE>ifp-&gt;if_mtu</CODE>
<DD>
The maximum transmission unit for the device.  For Ethernet
devices this value should almost always be 1500.

<DT><CODE>ifp-&gt;if_flags</CODE>
<DD>
The device flags.  Ethernet devices should set the flags
to <CODE>IFF_BROADCAST|IFF_SIMPLEX</CODE>, indicating that the
device can broadcast packets to multiple destinations
and does not receive and transmit at the same time.

<DT><CODE>ifp-&gt;if_snd.ifq_maxlen</CODE>
<DD>
The maximum length of the queue of packets waiting to be
sent to the driver.  This is normally set to <CODE>ifqmaxlen</CODE>.

<DT><CODE>ifp-&gt;if_init</CODE>
<DD>
The address of the driver initialization function.

<DT><CODE>ifp-&gt;if_start</CODE>
<DD>
The address of the driver start function.

<DT><CODE>ifp-&gt;if_ioctl</CODE>
<DD>
The address of the driver ioctl function.

<DT><CODE>ifp-&gt;if_output</CODE>
<DD>
The address of the output function.  Ethernet devices
should set this to <CODE>ether_output</CODE>.
</DL>

<P>
RTEMS provides a function to parse the driver name in the
configuration structure into a device name and unit number.
</P>
<DL><DT><DD>
<PRE>
int rtems_bsdnet_parse_driver_name (
  const struct rtems_bsdnet_ifconfig *config,
  char **namep
);
</PRE>
</DL>
<P>
The function takes two arguments; a pointer to the configuration
structure and a pointer to a pointer to a character.  The function
parses the configuration name entry, allocates memory for the driver
name, places the driver name in this memory, sets the second argument
to point to the name and returns the unit number.
On error, a message is printed and -1 is returned.
</P>
<P>
Once the attach function  has set up the above entries it must link the
driver data structure onto the list of devices by
calling <CODE>if_attach</CODE>.  Ethernet devices should then
call <CODE>ether_ifattach</CODE>.  Both functions take a pointer to the
device's <CODE>ifnet</CODE> structure as their only argument.
</P>
<P>
The attach function should return a non-zero value to indicate that
the driver has been successfully configured and attached.
</P>
<P><HR>
<LINK REL="Precedes" HREF="bsp_howto00119.html">
<LINK REV="Precedes" HREF="bsp_howto00117.html">
<LINK REV="Subdocument" HREF="bsp_howto00113.html">
<LINK REV="Library" HREF="../index.html">
</HEAD><BODY><P>
<A HREF="bsp_howto00117.html"><IMG ALIGN=MIDDLE SRC="../images/prev-arrow.gif" ALT="PREV"></A>
<A HREF="bsp_howto00113.html"> <IMG ALIGN=MIDDLE SRC="../images/up-arrow.gif" ALT="UP"></A>
<A HREF="bsp_howto00119.html"><IMG ALIGN=MIDDLE SRC="../images/next-arrow.gif" ALT="NEXT"></A>
<A HREF="../index.html"> <IMG ALIGN=MIDDLE SRC="../images/dir-arrow.gif" ALT="Bookshelf"></A>
<CITE>BSP and Device Driver Development Guide</CITE></P>
<P>Copyright &copy; 1988-2008 <A HREF="http://www.oarcorp.com" target="Text Frame">OAR Corporation</A>
</BODY></HTML>
