<HTML>
<!-- created Dec 13 2011 from linkcmds.texi line 392 via texi2www -->
<BODY BGCOLOR="FFFFFF">
<A HREF="http://www.rtems.com" target="Text Frame">
  <IMG align=right BORDER=0 SRC="../images/rtems_logo.jpg" ALT="RTEMS Logo"> </A>
<H1>RTEMS 4.10.2 On-Line Library</H1>
<HR>
<HEAD>
<TITLE>Linker Script Initialized Data</TITLE>
<LINK REL="Precedes" HREF="bsp_howto00019.html">
<LINK REV="Precedes" HREF="bsp_howto00017.html">
<LINK REV="Subdocument" HREF="bsp_howto00013.html">
<LINK REV="Library" HREF="../index.html">
</HEAD><BODY><P>
<A HREF="bsp_howto00017.html"><IMG ALIGN=MIDDLE SRC="../images/prev-arrow.gif" ALT="PREV"></A>
<A HREF="bsp_howto00013.html"> <IMG ALIGN=MIDDLE SRC="../images/up-arrow.gif" ALT="UP"></A>
<A HREF="bsp_howto00019.html"><IMG ALIGN=MIDDLE SRC="../images/next-arrow.gif" ALT="NEXT"></A>
<A HREF="../index.html"> <IMG ALIGN=MIDDLE SRC="../images/dir-arrow.gif" ALT="Bookshelf"></A>
<CITE>BSP and Device Driver Development Guide</CITE></P>
<H2>4.5: Initialized Data</H2>
<P>
Now there's a problem with the initialized data: the <CODE>.data</CODE> section
has to be in RAM as this data may be modified during the program execution.
But how will the values be initialized at boot time?
</P>
<P>
One approach is to place the entire program image in RAM and reload
the image in its entirety each time the program is run.  This is fine
for use in a debug environment where a high-speed connection is available
between the development host computer and the target.  But even in this
environment, it is cumbersome.
</P>
<P>
The solution is to place a copy of the initialized data in a separate
area of memory and copy it into the proper location each time the
program is started.  It is common practice to place a copy of the initialized
<CODE>.data</CODE> section at the end of the code (<CODE>.text</CODE>) section
in ROM when building a PROM image. The GNU tool <CODE>objcopy</CODE>
can be used for this purpose.
</P>
<P>
The following figure illustrates the steps a linked program goes through
to become a downloadable image.
</P>
<DL><DT><DD>
<PRE>
+--------------+     +--------------------+
| .data    RAM |     | .data          RAM |
+--------------+     +--------------------+
| .bss     RAM |     | .bss           RAM |
+--------------+     +--------------------+         +----------------+
| .text    ROM |     | .text          ROM |         |     .text      |
+--------------+     +--------------------+         +----------------+
                     | copy of .data  ROM |         | copy of .data  |
                     +--------------------+         +----------------+

      Step 1                Step 2                       Step 3
</PRE>
</DL>
<P>
In Step 1, the program is linked together using the BSP linker script.
</P>
<P>
In Step 2, a copy is made of the <CODE>.data</CODE> section and placed
after the <CODE>.text</CODE> section so it can be placed in PROM.  This step
is done after the linking time.  There is an example
of doing this in the file $RTEMS_ROOT/make/custom/gen68340.cfg:
</P>
<DL><DT><DD>
<PRE>
# make a PROM image using objcopy
m68k-rtems-objcopy \
--adjust-section-vma .data= \

`m68k-rtems-objdump --section-headers \
$(basename $@).exe \
| awk '[...]` \
$(basename $@).exe
</PRE>
</DL>
<P>
NOTE: The address of the &quot;copy of <CODE>.data</CODE> section&quot; is
created by extracting the last address in the <CODE>.text</CODE>
section with an <CODE>awk</CODE> script.  The details of how
this is done are not relevant.
</P>
<P>
Step 3 shows the final executable image as it logically appears in
the target's non-volatile program memory.  The board initialization
code will copy the &quot;&quot;copy of <CODE>.data</CODE> section&quot; (which are stored in
ROM) to their reserved location in RAM.
</P>
<P><HR>
<LINK REL="Precedes" HREF="bsp_howto00019.html">
<LINK REV="Precedes" HREF="bsp_howto00017.html">
<LINK REV="Subdocument" HREF="bsp_howto00013.html">
<LINK REV="Library" HREF="../index.html">
</HEAD><BODY><P>
<A HREF="bsp_howto00017.html"><IMG ALIGN=MIDDLE SRC="../images/prev-arrow.gif" ALT="PREV"></A>
<A HREF="bsp_howto00013.html"> <IMG ALIGN=MIDDLE SRC="../images/up-arrow.gif" ALT="UP"></A>
<A HREF="bsp_howto00019.html"><IMG ALIGN=MIDDLE SRC="../images/next-arrow.gif" ALT="NEXT"></A>
<A HREF="../index.html"> <IMG ALIGN=MIDDLE SRC="../images/dir-arrow.gif" ALT="Bookshelf"></A>
<CITE>BSP and Device Driver Development Guide</CITE></P>
<P>Copyright &copy; 1988-2008 <A HREF="http://www.oarcorp.com" target="Text Frame">OAR Corporation</A>
</BODY></HTML>
